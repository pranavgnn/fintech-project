import{u as ae,j as e,B as O,C as de,a as ue,b as fe,c as he,d as xe,e as me}from"./ui-DCtcd1Kk.js";import{r as l,u as pe,c as ge,R as je}from"./router-C32cmwfs.js";import{c as V,u as ve,f as $,o as be,g as Ce,h as ye,s as D,e as Se,d as H,n as Ee}from"./utils-DCNUdSfE.js";import{A as we,C as ke,a as Ne,F as Te,b as m,c as p,d as x,e as g,f as C,g as A,s as Ue}from"./alert-CsIf4CTI.js";import{A as Ie}from"./AdminLayout-Dt8VV5pt.js";import{t as _}from"./index-XEsyHGvM.js";import{u as Re,C as De,S as J,a as K,b as X,c as Y,d as N}from"./select-gkOMAzdD.js";import{I as G}from"./input-DjdrYohH.js";import{e as Fe,f as Pe,d as M,j as Q,k as Ae,q as _e,P as W,a as Z,b as ee}from"./RootLayout-Bf31PLGy.js";import{C as Le,b as Be,a as re}from"./calendar-BH1FcBMN.js";import"./charts-BMSya-r6.js";import"./react-Csw2ODfV.js";import"./Sidebar-CR8TwwPA.js";import"./gift-41HnvwwA.js";import"./chevron-right-AcBWCHTh.js";var L="Checkbox",[Oe,ir]=Pe(L),[$e,Ve]=Oe(L),oe=l.forwardRef((o,d)=>{const{__scopeCheckbox:n,name:j,checked:v,defaultChecked:u,required:S,disabled:f,value:E="on",onCheckedChange:T,form:w,...U}=o,[t,R]=l.useState(null),F=ae(d,a=>R(a)),b=l.useRef(!1),k=t?w||!!t.closest("form"):!0,[h,r]=Fe({prop:v,defaultProp:u??!1,onChange:T,caller:L}),s=l.useRef(h);return l.useEffect(()=>{const a=t==null?void 0:t.form;if(a){const c=()=>r(s.current);return a.addEventListener("reset",c),()=>a.removeEventListener("reset",c)}},[t,r]),e.jsxs($e,{scope:n,state:h,disabled:f,children:[e.jsx(M.button,{type:"button",role:"checkbox","aria-checked":y(h)?"mixed":h,"aria-required":S,"data-state":le(h),"data-disabled":f?"":void 0,disabled:f,value:E,...U,ref:F,onKeyDown:Q(o.onKeyDown,a=>{a.key==="Enter"&&a.preventDefault()}),onClick:Q(o.onClick,a=>{r(c=>y(c)?!0:!c),k&&(b.current=a.isPropagationStopped(),b.current||a.stopPropagation())})}),k&&e.jsx(ce,{control:t,bubbles:!b.current,name:j,value:E,checked:h,required:S,disabled:f,form:w,style:{transform:"translateX(-100%)"},defaultChecked:y(u)?!1:u})]})});oe.displayName=L;var ne="CheckboxIndicator",ie=l.forwardRef((o,d)=>{const{__scopeCheckbox:n,forceMount:j,...v}=o,u=Ve(ne,n);return e.jsx(Ae,{present:j||y(u.state)||u.state===!0,children:e.jsx(M.span,{"data-state":le(u.state),"data-disabled":u.disabled?"":void 0,...v,ref:d,style:{pointerEvents:"none",...o.style}})})});ie.displayName=ne;var Me="CheckboxBubbleInput",ce=l.forwardRef(({__scopeCheckbox:o,control:d,checked:n,bubbles:j=!0,defaultChecked:v,...u},S)=>{const f=l.useRef(null),E=ae(f,S),T=Re(n),w=_e(d);l.useEffect(()=>{const t=f.current;if(!t)return;const R=window.HTMLInputElement.prototype,b=Object.getOwnPropertyDescriptor(R,"checked").set;if(T!==n&&b){const k=new Event("click",{bubbles:j});t.indeterminate=y(n),b.call(t,y(n)?!1:n),t.dispatchEvent(k)}},[T,n,j]);const U=l.useRef(y(n)?!1:n);return e.jsx(M.input,{type:"checkbox","aria-hidden":!0,defaultChecked:v??U.current,...u,tabIndex:-1,ref:E,style:{...u.style,...w,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ce.displayName=Me;function y(o){return o==="indeterminate"}function le(o){return y(o)?"indeterminate":o?"checked":"unchecked"}var ze=oe,qe=ie;function te({className:o,...d}){return e.jsx(ze,{"data-slot":"checkbox",className:V("peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",o),...d,children:e.jsx(qe,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(De,{className:"size-3.5"})})})}function se({className:o,...d}){return e.jsx("textarea",{"data-slot":"textarea",className:V("border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",o),...d})}const He=be({title:D().min(3,"Title must be at least 3 characters long"),description:D().min(10,"Description must be at least 10 characters long"),category:D().min(1,"Category is required"),validFrom:H({required_error:"Valid from date is required"}),validUntil:H({required_error:"Valid until date is required"}),discount:D().optional(),targetType:Se(["ALL_USERS","SELECTED_USERS","CRITERIA_BASED"]),targetCriteria:D().optional(),targetUserIds:ye(Ee()).default([]),active:Ce().default(!0)}),cr=()=>{const o=pe(),{offerId:d}=ge(),[n,j]=l.useState(!1),[v,u]=l.useState(null),[S,f]=l.useState(!1),[E,T]=l.useState([]),[w,U]=l.useState([]),t=ve({resolver:Ue(He),defaultValues:{title:"",description:"",category:"",validFrom:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),discount:"",targetType:"ALL_USERS",targetCriteria:"",targetUserIds:[],active:!0}});l.useEffect(()=>{d&&(j(!0),R(d)),F()},[d]);const R=async r=>{var s;try{const a=localStorage.getItem("token"),c=await fetch(`/api/admin/offers/${r}`,{headers:{Authorization:`Bearer ${a}`}});if(!c.ok)throw new Error(`Failed to fetch offer: ${c.status}`);const i=await c.json(),P=((s=i.targetUsers)==null?void 0:s.map(B=>B.id))||[];U(P),t.reset({title:i.title||"",description:i.description||"",category:i.category||"",validFrom:i.validFrom?new Date(i.validFrom):new Date,validUntil:i.validUntil?new Date(i.validUntil):new Date(Date.now()+30*24*60*60*1e3),discount:i.discount||"",targetType:i.targetType||"ALL_USERS",targetCriteria:i.targetCriteria||"",targetUserIds:P,active:i.active!==void 0?i.active:!0})}catch(a){console.error("Error fetching offer:",a),_.error("Failed to load offer data"),o("/admin/offers")}},F=async()=>{try{const r=localStorage.getItem("token"),s=await fetch("/api/users",{headers:{Authorization:`Bearer ${r}`}});if(!s.ok)throw new Error(`Failed to fetch users: ${s.status}`);const a=await s.json();T(a)}catch(r){console.error("Error fetching users:",r),_.error("Failed to load users")}},b=(r,s)=>{U(a=>{const c=s?[...a,r]:a.filter(i=>i!==r);return t.setValue("targetUserIds",c),c})},k=async r=>{f(!0),u(null);try{if(r.targetType==="SELECTED_USERS"&&r.targetUserIds.length===0)throw new Error("Please select at least one user for targeted offers");const s=$(r.validFrom,"yyyy-MM-dd'T'HH:mm:ss"),a=$(r.validUntil,"yyyy-MM-dd'T'HH:mm:ss"),c={...r,validFrom:s,validUntil:a},i=localStorage.getItem("token");if(!i)throw new Error("Authentication token not found");const P=n?"PUT":"POST",B=n?`/api/admin/offers/${d}`:"/api/admin/offers",I=await fetch(B,{method:P,headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(c)});if(!I.ok){const z=await I.text();if(I.status===403)throw new Error("You don't have permission to manage offers");if(I.status===401)throw new Error("Authentication expired. Please login again");try{const q=JSON.parse(z);throw new Error(q.message||`Error: ${I.status}`)}catch{throw new Error(`Error: ${I.status}. ${z}`)}}_.success(n?"Offer updated successfully":"Offer created successfully"),o("/admin/offers")}catch(s){console.error("Error saving offer:",s),u(s.message||"Failed to save offer"),_.error(s.message||"Failed to save offer")}finally{f(!1)}},h=je.forwardRef(({value:r,onClick:s,className:a,placeholder:c="Pick a date"},i)=>e.jsxs("div",{onClick:s,ref:i,className:V("flex h-10 w-full rounded-md border border-input px-3 py-2 text-sm ring-offset-background cursor-pointer","flex items-center justify-between",!r&&"text-muted-foreground",a),children:[r?$(r,"PPP"):e.jsx("span",{children:c}),e.jsx(Le,{className:"h-4 w-4 opacity-50"})]}));return h.displayName="DatePickerButton",e.jsx(Ie,{children:e.jsxs("div",{className:"flex-1 space-y-4 p-6 md:p-8",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{variant:"outline",size:"icon",onClick:()=>o("/admin/offers"),className:"mr-4",children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:n?"Edit Offer":"Create New Offer"})]}),e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(fe,{children:n?"Update Offer":"Create Offer"}),e.jsx(he,{children:n?"Update the offer details below":"Fill in the details to create a new offer"})]}),e.jsxs(xe,{children:[v&&e.jsxs(we,{variant:"destructive",className:"mb-6",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(Ne,{children:v})]}),e.jsx(Te,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(k),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(m,{control:t.control,name:"title",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Title"}),e.jsx(g,{children:e.jsx(G,{placeholder:"Enter offer title",...r})}),e.jsx(C,{})]})}),e.jsx(m,{control:t.control,name:"category",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Category"}),e.jsxs(J,{onValueChange:r.onChange,value:r.value,children:[e.jsx(g,{children:e.jsx(K,{children:e.jsx(X,{placeholder:"Select a category"})})}),e.jsxs(Y,{children:[e.jsx(N,{value:"Savings",children:"Savings"}),e.jsx(N,{value:"Transfer",children:"Transfer"}),e.jsx(N,{value:"Credit Card",children:"Credit Card"}),e.jsx(N,{value:"Loan",children:"Loan"})]})]}),e.jsx(C,{})]})})]}),e.jsx(m,{control:t.control,name:"description",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Description"}),e.jsx(g,{children:e.jsx(se,{placeholder:"Enter offer description",className:"min-h-[120px]",...r})}),e.jsx(C,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(m,{control:t.control,name:"validFrom",render:({field:r})=>e.jsxs(p,{className:"flex flex-col",children:[e.jsx(x,{children:"Valid From"}),e.jsxs(W,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(g,{children:e.jsx(h,{value:r.value})})}),e.jsx(ee,{className:"w-auto p-0",align:"start",children:e.jsx(re,{mode:"single",selected:r.value,onSelect:s=>s&&r.onChange(s)})})]}),e.jsx(C,{})]})}),e.jsx(m,{control:t.control,name:"validUntil",render:({field:r})=>e.jsxs(p,{className:"flex flex-col",children:[e.jsx(x,{children:"Valid Until"}),e.jsxs(W,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(g,{children:e.jsx(h,{value:r.value})})}),e.jsx(ee,{className:"w-auto p-0",align:"start",children:e.jsx(re,{mode:"single",selected:r.value,onSelect:s=>s&&r.onChange(s),disabled:s=>s<new Date})})]}),e.jsx(C,{})]})})]}),e.jsx(m,{control:t.control,name:"discount",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Discount (Optional)"}),e.jsx(g,{children:e.jsx(G,{placeholder:"e.g. 10%, 50 INR off, etc.",...r})}),e.jsx(A,{children:"Specify the discount amount or percentage"}),e.jsx(C,{})]})}),e.jsx(m,{control:t.control,name:"targetType",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Target Audience"}),e.jsxs(J,{onValueChange:r.onChange,value:r.value,children:[e.jsx(g,{children:e.jsx(K,{children:e.jsx(X,{placeholder:"Select target audience"})})}),e.jsxs(Y,{children:[e.jsx(N,{value:"ALL_USERS",children:"All Users"}),e.jsx(N,{value:"SELECTED_USERS",children:"Selected Users"}),e.jsx(N,{value:"CRITERIA_BASED",children:"Criteria Based"})]})]}),e.jsx(A,{children:"Determine who will be eligible for this offer"}),e.jsx(C,{})]})}),t.watch("targetType")==="SELECTED_USERS"&&e.jsxs("div",{children:[e.jsx(x,{children:"Selected Users"}),e.jsx("div",{className:"mt-2 border rounded-md p-4 max-h-60 overflow-y-auto space-y-2",children:E.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading users..."}):E.map(r=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(te,{id:`user-${r.id}`,checked:w.includes(r.id),onCheckedChange:s=>b(r.id,s===!0)}),e.jsxs("label",{htmlFor:`user-${r.id}`,className:"text-sm cursor-pointer",children:[r.name," (",r.email,")"]})]},r.id))}),w.length===0&&t.watch("targetType")==="SELECTED_USERS"&&e.jsx("p",{className:"text-xs text-amber-500 mt-2",children:"Please select at least one user"})]}),t.watch("targetType")==="CRITERIA_BASED"&&e.jsx(m,{control:t.control,name:"targetCriteria",render:({field:r})=>e.jsxs(p,{children:[e.jsx(x,{children:"Target Criteria"}),e.jsx(g,{children:e.jsx(se,{placeholder:"e.g. account.balance > 10000 AND user.age > 25",className:"min-h-[80px]",...r})}),e.jsx(A,{children:"Specify criteria for eligible users"}),e.jsx(C,{})]})}),e.jsx(m,{control:t.control,name:"active",render:({field:r})=>e.jsxs(p,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4",children:[e.jsx(g,{children:e.jsx(te,{checked:r.value,onCheckedChange:r.onChange})}),e.jsxs("div",{className:"space-y-1 leading-none",children:[e.jsx(x,{children:"Active"}),e.jsx(A,{children:"This offer will be visible to users if active"})]})]})})]})})]}),e.jsxs(me,{className:"flex justify-between",children:[e.jsx(O,{type:"button",variant:"outline",onClick:()=>o("/admin/offers"),children:"Cancel"}),e.jsx(O,{onClick:t.handleSubmit(k),disabled:S,children:S?"Saving...":n?"Update Offer":"Create Offer"})]})]})]})})};export{cr as default};
